<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PostgreSQL Production Setup on Google Cloud SQL - Debugging Grimoire</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Debugging Grimoire</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="set-up-postgresql-for-deployment-with-cloud-sql"><a class="header" href="#set-up-postgresql-for-deployment-with-cloud-sql">Set Up PostgreSQL for Deployment With Cloud SQL</a></h1>
<p>‚úÖ Go to Google Cloud Console ‚Üí Create a PostgreSQL instance
‚úÖ Pick a region close to your Cloud Run service (to reduce latency)
‚úÖ Enable Automatic Backups (trust me, you‚Äôll need them someday)
‚úÖ Disable public IP (we only connect through the Cloud SQL Proxy)
2Ô∏è‚É£ Connect Securely (No Direct Superuser Access)</p>
<p>üö´ No sudo -u postgres psql
‚úÖ Use the Cloud SQL Auth Proxy instead:</p>
<p>gcloud auth application-default login
gcloud sql connect my-instance --user=my_project_user</p>
<p>1Ô∏è‚É£ Create a Service Account for PostgreSQL</p>
<p>Since Google Cloud SQL supports IAM authentication, we‚Äôll create a dedicated service account for your database.</p>
<p>gcloud iam service-accounts create cloudsql-user <br />
--description="Cloud SQL authentication service account" <br />
--display-name="CloudSQL User"</p>
<p>2Ô∏è‚É£ Grant Cloud SQL Permissions</p>
<p>This gives only the required permissions to the service account‚Äînothing more.</p>
<p>gcloud projects add-iam-policy-binding $YOUR_PROJECT_ID <br />
--member=serviceAccount:cloudsql-user@$YOUR_PROJECT_ID.iam.gserviceaccount.com <br />
--role=roles/cloudsql.client</p>
<p>gcloud projects add-iam-policy-binding $YOUR_PROJECT_ID <br />
--member=serviceAccount:cloudsql-user@$YOUR_PROJECT_ID.iam.gserviceaccount.com <br />
--role=roles/cloudsql.instanceUser</p>
<p>üõë DO NOT give roles/cloudsql.admin unless Future-You wants to cry over accidental privilege escalations.
3Ô∏è‚É£ Enable IAM Authentication for Cloud SQL</p>
<p>Cloud SQL needs to allow IAM users to authenticate instead of just using password-based logins.</p>
<p>gcloud sql instances patch YOUR_INSTANCE_NAME <br />
--database-flags=cloudsql.iam_authentication=on</p>
<p>üîπ This tells Postgres to use IAM authentication for users. If this is missing, IAM-based logins will fail.
4Ô∏è‚É£ Create a Cloud SQL User with IAM Authentication</p>
<p>Now, you create a database user, but instead of a password, it will authenticate via IAM.</p>
<p>gcloud sql users create cloudsql-user <br />
--instance=YOUR_INSTANCE_NAME <br />
--type=CLOUD_IAM_SERVICE_ACCOUNT <br />
--email=cloudsql-user@$YOUR_PROJECT_ID.iam.gserviceaccount.com</p>
<p>5Ô∏è‚É£ Generate Credentials for Local Testing</p>
<p>You‚Äôll need an authentication token every time you connect to Postgres via IAM.</p>
<p>gcloud auth application-default login
gcloud auth print-access-token</p>
<p>Copy the access token and use it as a password when connecting via psql.
6Ô∏è‚É£ Connect to Cloud SQL Using IAM Authentication</p>
<p>Use this instead of a password:</p>
<p>PGPASSWORD=$(gcloud auth print-access-token) psql <br />
"host=/cloudsql/YOUR_PROJECT_ID:YOUR_REGION:YOUR_INSTANCE_NAME <br />
dbname=my_project_db <br />
user=cloudsql-user@$YOUR_PROJECT_ID.iam.gserviceaccount.com <br />
sslmode=disable"</p>
<p>üîπ This removes static passwords and forces authentication via IAM.
7Ô∏è‚É£ GitHub Actions Integration (For Automated Deployments)</p>
<p>Since you‚Äôre already storing credentials in GitHub Secrets, you‚Äôll also need to store IAM authentication tokens.</p>
<pre><code>Add two more secrets:
    GCP_SQL_IAM_USER ‚Üí cloudsql-user@$YOUR_PROJECT_ID.iam.gserviceaccount.com
    GCP_SQL_INSTANCE_CONNECTION_NAME ‚Üí YOUR_PROJECT_ID:YOUR_REGION:YOUR_INSTANCE_NAME
</code></pre>
<p>3Ô∏è‚É£ Database Setup (Same as Local, But With IAM Users)</p>
<p>For this step, you should follow the <a href="../database/postgres-local.html">PostgreSQL Local Setup Guide</a> from Step 2, as it also works for this setup.</p>
<p>Cloud Run Deployment: The Database URL Format</p>
<p>Instead of localhost, your .env file should have:</p>
<p>DATABASE_URL=postgres://my_project_user:supersecurepassword@/my_project_db?host=/cloudsql/YOUR_PROJECT_ID:YOUR_REGION:YOUR_INSTANCE_NAME</p>
<p>To test manually:</p>
<p>psql "postgres://my_project_user:supersecurepassword@/my_project_db?host=/cloudsql/YOUR_PROJECT_ID:YOUR_REGION:YOUR_INSTANCE_NAME"</p>
<p>5Ô∏è‚É£ Security: Avoid Paying for Google‚Äôs Mistakes</p>
<p>üî¥ Set up a billing alert. If your database starts scaling up unnecessarily, you will get charged.
üü¢ Limit instance size in the Cloud SQL settings (e.g., 1 vCPU, 2GB RAM for small apps).
üõë No open database connections! Use Cloud SQL Proxy instead of exposing your DB.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../devops/postgres-testing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../linux/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../devops/postgres-testing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../linux/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
